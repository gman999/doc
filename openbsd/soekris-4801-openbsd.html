<h2 id="soekris4801:continuingrelevanceafteralltheseyears">Soekris 4801: Continuing Relevance After All These Years</h2>

<p>The venerable <a href="https://soekris.com">Soekris 4801</a> with its 128 megabytes of RAM and slow 233 MHz processor can still maintain a useful role. Thousands reside quietly in drawers and closets around the globe, imagined to be far past their expiration date.</p>

<p>OpenBSD is an ideal candidate operating system for the Soekris, since it&#8217;s built lean by default, yet an array of functions are available in the base system.</p>

<p>Such a device could be a serial console server, a recursive/caching DNS, a lightweight monitoring server, etc., without installing any third-party software.</p>

<h3 id="theinstall">The Install</h3>

<p>Needs:</p>

<ul>
<li><p>bootable media with OpenBSD/i386 stable version on a <a href="http://www.openbsd.org/faq/faq4.html#Flash">USB stick</a>. Using snapshots is not ideal in this scenario.</p></li>
<li><p>compact flash (CF) card with adapter</p></li>
<li><p>bootstrap i386/amd64 computer with any operating system</p></li>
<li><p>a serial console cable with a null modem</p></li>
</ul>

<p>With the bootable media attached via USB, launch the bootstrap computer and enter the OpenBSD installation program.</p>

<p>Type <strong>i</strong> to enter the install system.</p>

<pre><code>Welcome to the OpenBSD/i386 5.8 installation program.
(I)nstall, (U)pgrade, (A)utoinstall or (S)hell? i
</code></pre>

<p>Plug in the CF card adapter and note the device listed to standard output, normally sd(4) with a respective number, such as sd2.</p>

<p>The OpenBSD installation program is graphics-free, yet clear and simple to follow.</p>

<p>Hit &#8220;enter&#8221; for [default]</p>

<pre><code>Choose your keyboard layout ('?' or 'L' for list) [default]
</code></pre>

<p>Designate the system&#8217;s hostname</p>

<pre><code>System hostname? (short form, e.g. 'foo')
</code></pre>

<p>Next the list of interfaces will be listed, both wired and the recognized wireless devices. This can be configured for DHCP, as it will only be used to pull the relevant install sets from an OpenBSD mirror. Note that the interfaces only apply temporarily to the bootstrap computer, and will need to be adjusted manually on the actual Soekris device which uses sis(4) for the network interfaces.</p>

<pre><code>Password for root account? (will not echo)
</code></pre>

<p>sshd(8) will likely be necessary.</p>

<pre><code>Start sshd(8) by default [yes]? yes
</code></pre>

<p>For the functions listed previously, X Windows and xdm(1) are unnecessary.</p>

<pre><code>Do you want the X Window System to be started by xdm(1)? [no] no
</code></pre>

<p>A non-privileged user is an important step in running a secure system.</p>

<pre><code>Setup a user? (enter a lower-case loginname, or 'no') [no]  

Allow root ssh login? (yes, no, prohibit-password) [no] no

What timezone are you in? ('?' for list) [(local timezone guess)]
</code></pre>

<p>Next is determining the install disk.</p>

<pre><code>Available disks are: sd0 sd1 sd2.
</code></pre>

<p>In this case, standard output noted that the CF card is located on sd2. An incorrect choice here, such as selecting the bootstrap computer&#8217;s disk, will mean overwriting the wrong disk.</p>

<p>Select <strong>?</strong> to verify the correct disk.</p>

<pre><code>Which disk is the root disk? ('?' for details) [sd0] ?
</code></pre>

<p>Enter the appropriate disk, in this case it&#8217;s sd2</p>

<p>Next the fdisk(8) utility runs displaying the slice breakdown of the disk.</p>

<p>Choose <strong>w</strong> to utilize the entire disk.</p>

<pre><code>Use (W)hole disk, use the (O)penBSD area, or (E)dit the MBR? [OpenBSD] w
</code></pre>

<p>Next the autoconfigured partition layout will be displayed. Unless there are particular needs, choose <strong>a</strong> for auto.</p>

<pre><code>Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout [a]? a
</code></pre>

<p>At this point, the installer will ask for the next disk to configure. Type <strong>done</strong> as our disk setup is complete.</p>

<pre><code>Which disk do you wish to initialize? (or 'done') [done]
</code></pre>

<p>Then the install sets need to be accessed, either on a local disk or via HTTP. <strong>http</strong> is our choice, as the install media didn&#8217;t contain the files.</p>

<pre><code>Let's install the sets!

Location of sets? (disk http or 'done') [http] http
</code></pre>

<p>If you&#8217;re using a proxy, enter it here.</p>

<pre><code>HTTP proxy URL? (e.g. 'http://proxy:8080', or 'none') [none]
</code></pre>

<p>Now enter an OpenBSD mirror. Typing <strong>?</strong> will display a list of the current mirrors.</p>

<pre><code>HTTP Server? (hostname, list#, 'done' or '?')
</code></pre>

<p>The OpenBSD project insists on maintaining identically directory hierarchies on their mirrors. The next prompt should illustrate why, since you just need to hit &#8220;enter.&#8221;</p>

<pre><code>Server directory? [pub/OpenBSD/5.8/i386]
</code></pre>

<p>Now the full list of sets is displayed. In our case, the Soekris install should be painfully small, and not contain any unnecessary parts of the base system.</p>

<pre><code>Set name(s)? (or 'abort' or 'done') [done]
</code></pre>

<p>To remove install sets, type - before the ones you want to remove, including the SMP kernel, since Soekris has an ancient CPU.</p>

<pre><code>-bsd.mp

-comp*

-man*

-game*

-x*
</code></pre>

<p>At this point there should only be three install sets remaining: bsd, bsd.rd and base58.tgz.</p>

<pre><code>Location of sets? (disk http or 'done') [http] done
</code></pre>

<p>We are quite sure the bsd.mp kernel is unnecessary, so type <strong>yes</strong>.</p>

<pre><code>Are you *SURE* your install is complete without 'bsd.mp'? [no] yes
</code></pre>

<p>The install process will complete and return to a prompt, from which we&#8217;ll reboot.</p>

<pre><code># reboot
</code></pre>

<p>As the system reboots remove the USB disk with the install media and the CF card adapter.</p>

<p>Ideally, the bootstrap computer will boot normally, and you didn&#8217;t do a fresh OpenBSD install to the wrong disk. Measure twice, cut once!</p>

<h3 id="pre-firstbootconfiguration">Pre-First Boot Configuration</h3>

<p>There is an important set of changes to make to successfully boot the Soekris board with OpenBSD as there is no VGA output, and the default output is to console.</p>

<p>The default install will cease booting at this line unless console access is enabled.</p>

<pre><code>entry point at 0x200120
</code></pre>

<p>The easiest way to make these changes is to mount(8) the CF card on an OpenBSD computer and manually make the changes.</p>

<pre><code>mount /dev/sd2a /mnt
</code></pre>

<p>In /etc/ttys, change this line:</p>

<pre><code>tty00   &quot;/usr/libexec/getty std.9600&quot;   unknown off
</code></pre>

<p>to this:</p>

<pre><code>tty00   &quot;/usr/libexec/getty std.9600&quot;   vt220   on secure
</code></pre>

<p>Create /etc/boot.conf, and add the following line:</p>

<pre><code>set tty com0
</code></pre>

<h3 id="finalconfiguration">Final Configuration</h3>

<p>Setup the non-privileged user with doas(1) permissions in /etc/doas.conf(5):</p>

<pre><code>permit nopass keepenv {user} as root
</code></pre>

<p>Create /etc/rc.conf.local for minimizing unnecessary daemons, such as sndiod(1) and smtpd(8):</p>

<pre><code>sndiod_flags=NO
smtpd_flags=NO
</code></pre>

<p>Install the CF card into the Soekris, plug in an ethernet cable to the first port on the right and plug in the serial console cable.</p>

<h3 id="bootingup">Booting Up</h3>

<p>Setup the bootstrap computer with the serial console cable and some terminal emulation application.</p>

<p>By default, the Soekris 4801 used 19200 as the console speed, yet we set the speed to 9600 in the /etc/boot.conf and /etc/ttys files. Therefore, set the Soekris console speed to 9600 in the BIOS by hitting control-p during the Soekris&#8217; initial boot stage.</p>

<p>To show the current BIOS settings:</p>

<pre><code>comBIOS monitor.   Press ? for help.

&gt; show
</code></pre>

<p>Set the console speed to 9600.</p>

<pre><code>&gt; set conspeed=9600
</code></pre>

<p>Begin booting OpenBSD with the new settings.</p>

<pre><code>&gt; boot
</code></pre>

<p>Finally, it&#8217;s necessary to configure the sis(4) network interface as directed by hostname.if(5).</p>

<pre><code>vi /etc/hostname.sis0
</code></pre>

<p>Either set a static address with:</p>

<pre><code>inet {IP} netmask {netmask}
</code></pre>

<p>Or set to dhcp:</p>

<pre><code>dhcp
</code></pre>

<p>Reboot and the Soekris is ready for the particular function you&#8217;ve chosen.</p>
